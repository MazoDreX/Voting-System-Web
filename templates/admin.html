<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="{{url_for('static',filename='css/output.css')}}" rel="stylesheet">
</head>
<!-- UNTUK FLASH MESSAGE -->
{% with messages = get_flashed_messages(with_categories=True) %}
  {% if messages %}
    <div class="fixed top-5 right-5 space-y-4">
      {% for category, message in messages %}
        <div class="p-4 text-white rounded-lg shadow-lg {{ 'bg-green-500' if category == 'success' else 'bg-red-500' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<body>
    <!-- Modal Konfirmasi tidak berubah -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Konfirmasi Hapus</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Apakah anda yakin ingin menghapus kandidat ini?</p>
                </div>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        Ya, Hapus
                    </button>
                    <button id="cancelDelete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-4xl w-full space-y-8 p-8 bg-white rounded-xl shadow-md">
            <!-- Header dan navigasi tidak berubah -->
            <div class="text-center">
                <h1 id="welcomeHeader" class="text-3xl font-bold"></h1>
                <p class="mt-4">Apa yang anda ingin lakukan?</p>
            </div>

            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                <button 
                    onclick="toggleCandidates()"
                    class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                >
                    Kelola kandidat
                </button>
                <button
                    onclick="toggleVoter()"
                    class="w-full sm:w-auto px-4 py-2 border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50 transition-colors"
                >
                    Kelola Voter
                </button>
            </div>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                <button
                    onclick="updateVotingStatus('start')"
                    class="w-full sm:w-auto px-4 py-2 border border-green-600 text-green-600 rounded-md hover:bg-blue-50 transition-colors"
                >
                    Mulai Voting
                </button>
                <button 
                    onclick="updateVotingStatus('end')"
                    class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-950 transition-colors"
                >
                    Hentikan Voting
                </button>
            </div>
            

            <div id="candidatesSection" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4">Daftar Kandidat</h2>
                
                <!-- Form yang disesuaikan dengan backend -->
                <form id="addCandidateForm" class="mb-4 space-y-4" enctype="multipart/form-data">
                    <div class="flex gap-2">
                        <input
                            type="text"
                            name="name"
                            placeholder="Nama Kandidat"
                            class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        >
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Foto Kandidat
                        </label>
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <img id="imagePreview" src="/static/image/hebat.jpg" alt="Preview" 
                                    class="w-[150px] h-[150px] object-cover rounded-lg border-2 border-gray-200">
                            </div>
                            <div class="flex flex-col gap-2">
                                <input
                                    type="file"
                                    name="photo"
                                    accept=".jpg,.jpeg,.png"
                                    class="block w-full text-sm text-gray-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-md file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-blue-50 file:text-blue-700
                                        hover:file:bg-blue-100"
                                    required
                                >
                                <p class="text-xs text-gray-500">Format: JPG, PNG</p>
                            </div>
                        </div>
                    </div>
                    <button 
                        type="submit"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    >
                        Tambah Kandidat
                    </button>
                </form>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Kandidat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="candidatesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div id="voterSection" class="mt-8 hidden">
                <!-- Add Voter Button -->
                <div class="p-4">
                    <button onclick="showAddForm()" class="mb-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Add New Voter
                    </button>
                </div>
                <div class="p-4">
                    <table class="min-w-full bg-white shadow-md rounded-lg overflow-hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Lahir</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QR CODE</th>
                            </tr>
                        </thead>
                        <tbody id="VoterTableBody" class="bg-white divide-y divide-gray-200">

                        </tbody>
                    </table>
                </div>
            </div>

            <div id="addVoterModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Voter</h3>
                        <form id="voterForm" class="mt-4">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="nama">Nama</label>
                                <input type="text" id="nama" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="id">ID</label>
                                <input type="text" id="id" name="id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="tanggalLahir">Tanggal Lahir</label>
                                <input type="date" id="tanggalLahir" name="tanggalLahir" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="jenisKelamin">Jenis Kelamin</label>
                                <select id="jenisKelamin" name="jenisKelamin" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="alamat">Alamat</label>
                                <textarea id="alamat" name="alamat" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                            <div class="flex items-center justify-between mt-4">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    Submit
                                </button>
                                <button type="button" onclick="hideAddForm()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8">
                <a href="/logout">
                    <button class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                        Logout
                    </button>
                </a>
            </div>
        </div>
    </div>

    <script>
        let candidates = [];
        let candidateToDelete = null;
        let voters = [];
        let votersToDelete = null;

        async function updateVotingStatus(action) {
            const response = await fetch(`/admin/${action}_voting`, { method: "POST" });
            const result = await response.json();
            alert(result.message);
        }

        document.addEventListener("DOMContentLoaded", () => {
            const flashMessages = document.querySelectorAll(".fixed .p-4");
            setTimeout(() => {
            flashMessages.forEach(msg => msg.remove());
            }, 5000); // Hilang setelah 5 detik
        });
        
        // Preview gambar
        const fileInput = document.querySelector('input[type="file"]');
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission untuk Kelola Kandidat
        document.getElementById("addCandidateForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch("/api/candidates/", {
                    method: "POST",
                    body: formData,
                });
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    event.target.reset();
                    document.getElementById('imagePreview').src = '/static/uploads/candidates/default.png';
                    await loadCandidates();
                } else {
                    alert(result.error || "Terjadi kesalahan.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Terjadi kesalahan saat menambah kandidat.");
            }
        });

        function hideAddForm() {
            document.getElementById('addVoterModal').classList.add('hidden');
        }

        // Handle form submission untuk Kelola Voter
        document.getElementById('voterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target); 
            try {
                const response = await fetch("/api/voters/", { 
                    method: 'POST',
                    body: formData 
                });
                if (response.ok) {
                    hideAddForm();
                    loadVoters(); 
                    e.target.reset(); 
                } else {
                    // Tangani respons gagal
                    const errorData = await response.json();
                    console.error('Error adding voter:', errorData);
                    alert('Gagal menambahkan voter: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding voter:', error);
                alert('Gagal terhubung ke server.');
            }
        });


        // Load when page loads
        document.addEventListener('DOMContentLoaded', loadVoters);
        function setUsername(username = 'Admin') {
            document.getElementById('welcomeHeader').textContent = `Welcome, Admin ${username}!`;
        }

        function toggleCandidates() {
        const candidatesSection = document.getElementById('candidatesSection');
        const voterSection = document.getElementById('voterSection');
        
            if (candidatesSection.classList.contains('hidden')) {
                voterSection.classList.add('hidden');
                candidatesSection.classList.remove('hidden');
                loadCandidates();
            } else {
                candidatesSection.classList.add('hidden');
            }
        }

        function toggleVoter() {
            const voterSection = document.getElementById('voterSection');
            const candidatesSection = document.getElementById('candidatesSection');
            
            if (voterSection.classList.contains('hidden')) {
                candidatesSection.classList.add('hidden');
                voterSection.classList.remove('hidden');
                loadVoters();
            } else {
                voterSection.classList.add('hidden');
            }
        }

        async function loadCandidates() {
            try {
                const response = await fetch('/api/candidates/');
                const data = await response.json();
                
                if (response.ok) {
                    candidates = data.candidates;
                    renderCandidates();
                } else {
                    alert(data.error || "Gagal memuat data kandidat");
                }
            } catch (error) {
                console.error('Error loading candidates:', error);
                alert("Terjadi kesalahan saat memuat data kandidat");
            }
        }

        async function loadVoters() {
            try {
                const response = await fetch('/api/voters'); // Replace with your API endpoint
                const data = await response.json();
                if (response.ok) {
                    voters = data.voters;
                    renderVoters();
                } else {
                    alert(data.error || "Gagal memuat data kandidat");
                }
            } catch (error) {
                console.error('Error loading voters:', error);
            }
        }

        function renderCandidates() {
            const tableBody = document.getElementById('candidatesTableBody');
            tableBody.innerHTML = '';
            
            candidates.forEach((candidate, index) => {
                const photoUrl = candidate.photo 
                    ? `/static/uploads/candidates/${candidate.photo}`
                    : '/static/uploads/candidates/default.png';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${photoUrl}" 
                             alt="${candidate.name}" 
                             class="w-12 h-12 rounded-full object-cover">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${candidate.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="showDeleteConfirmation(${index})"
                            class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
                        >
                            Hapus
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderVoters() {
            const tableBody = document.getElementById("VoterTableBody")
            tableBody.innerHTML = '';

            voters.forEach((voter, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index+1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.tanggalLahir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.jenisKelamin}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${voter.alamat}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <img src="${voter.qr_code}" alt="QR Code" class="w-24 h-24">
                        </td>
                    `;
                    tableBody.appendChild(row);
            });
        } 
        

        function showDeleteConfirmation(index) {
            candidateToDelete = index;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function hideDeleteConfirmation() {
            document.getElementById('confirmModal').classList.add('hidden');
            candidateToDelete = null;
        }

        async function deleteCandidate() {
            if (candidateToDelete === null) return;
            
            try {
                const response = await fetch(`/api/candidates/${candidateToDelete}`, { 
                    method: 'DELETE' 
                });
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    hideDeleteConfirmation();
                    await loadCandidates();
                } else {
                    alert(result.error || "Gagal menghapus kandidat");
                }
            } catch (error) {
                console.error('Error:', error);
                alert("Terjadi kesalahan saat menghapus kandidat");
            }
        }

        // Show add form modal
        function showAddForm() {
            document.getElementById('addVoterModal').classList.remove('hidden');
        }

        // Hide add form modal
        function hideAddForm() {
            document.getElementById('addVoterModal').classList.add('hidden');
        }


        // Event listeners untuk modal
        document.getElementById('confirmDelete').addEventListener('click', deleteCandidate);
        document.getElementById('cancelDelete').addEventListener('click', hideDeleteConfirmation);
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDeleteConfirmation();
            }
        });

        // Initialize
        setUsername();

        function copyQRCode() {
            const qrCode = document.getElementById('qrCode');
            const copyMessage = document.getElementById('copyMessage');

            // Create a canvas element
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = qrCode.width;
            canvas.height = qrCode.height;
            
            // Draw the image on canvas
            ctx.drawImage(qrCode, 0, 0);
            
            // Convert the canvas to blob
            canvas.toBlob(function(blob) {
                // Create a ClipboardItem
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]).then(function() {
                    // Show success message
                    copyMessage.classList.remove('hidden');
                    setTimeout(() => {
                        copyMessage.classList.add('hidden');
                    }, 2000);
                }).catch(function(error) {
                    console.error('Error copying QR code:', error);
                });
            });
        }
    </script>
</body>
</html>